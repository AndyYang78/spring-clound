<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout" lang="zh-CN" layout:decorator="layout">
<head>
    <title>头像/背景审核</title>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_hader" th:content="${_csrf.headerName}"/>
    <meta name="viewport" content="width=1000, initial-scale=1.0, maximum-scale=1.0">
    <!-- 后端变量在这里处理 -->
    <script th:inline="javascript">
        var page = [[${page}]];
    </script>
    <script src="/common/plugins/iCheck/icheck.js"></script>
    <script src="/common/plugins/iCheck/custom.js"></script>
    <link rel="stylesheet" href="/common/bootstrap/css/toastr.min.css"/>
    <link rel="stylesheet" href="/common/plugins/colorpicker/bootstrap-colorpicker.min.css"/>
    <script src="/common/plugins/datepicker/bootstrap-datepicker.js"></script>
    <script src="/common/plugins/datepicker/locales/bootstrap-datepicker.zh-CN.js" charset="UTF-8"></script>
    <link rel="stylesheet" href="/common/plugins/datepicker/datepicker3.css">

</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
    <div class="content-wrapper" layout:fragment="content">
        <section class="content-header">
            <h1><i class="fa fa-eye">&nbsp;</i>
                头像/背景审核
                <small>审核头像/背景审核</small>
            </h1>
            <ol class="breadcrumb">
                <li><a href="#"><i class="fa fa-dashboard"></i> 用户</a></li>
                <li class="active">头像/背景审核</li>
            </ol>
        </section>
        <section id="main" class="content">
            <div class="row">
                <div class="col-xs-12">
                    <div class="box box-info">
                        <div class="box-header">
                            <h3 class="box-title"><i class="fa fa-filter"></i>筛选条件</h3>
                        </div>
                        <div class="box-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label>搜索内容:</label>
                                    <div class="input-group input-group-md">
                                        <div class="input-group-btn">
                                            <button type="button" id="sel_name" class="btn btn-info dropdown-toggle" data-toggle="dropdown">用户ID
                                                <span class="fa fa-caret-down"></span></button>
                                            <ul class="dropdown-menu">
                                                <li><a href="#">用户ID</a></li>
                                                <li><a href="#">昵称</a></li>
                                                <li><a href="#">手机号</a></li>
                                            </ul>
                                        </div>
                                        <input type="text" id="txt_query" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-1 col-md-1 col-sm-4 col-xs-6">
                                    <label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                                    <div class="form-group">
                                        <label>
                                            vip等级:
                                        </label>
                                    </div>
                                </div>
                                <div class="col-lg-1 col-md-1 col-sm-4 col-xs-6">
                                    <label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" name="vip" value="vip1" class="flat-red">
                                            vip1
                                        </label>
                                    </div>
                                </div>
                                <div class="col-lg-1 col-md-1 col-sm-4 col-xs-6">
                                    <label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                                    <div class="form-group">
                                    <label>
                                        <input type="checkbox" name="vip" value="vip2" class="flat-red">
                                         vip2
                                    </label>
                                    </div>
                                </div>
                                <div class="col-lg-1 col-md-1 col-sm-4 col-xs-6">
                                    <label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" name="vip" value="vip3" class="flat-red">
                                            vip3
                                        </label>
                                    </div>
                                </div>
                                <div class="col-lg-1 col-md-1 col-sm-4 col-xs-6">
                                    <label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" name="vip" value="vip4" class="flat-red">
                                            vip4
                                        </label>
                                    </div>
                                </div>
                                <div class="col-lg-1 col-md-1 col-sm-2 col-xs-4">
                                    <label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" name="vip" value="vip5" class="flat-red">
                                            vip5
                                        </label>
                                    </div>
                                </div>
                                <div class="col-lg-1 col-md-1 col-sm-4 col-xs-6">
                                    <label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" name="vip" value="vip6" class="flat-red">
                                            vip6
                                        </label>
                                    </div>
                                </div>
                                <div class="col-lg-1 col-md-1 col-sm-4 col-xs-6">
                                    <label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" name="vip" value="vip7" class="flat-red">
                                            vip7
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-2 col-sm-3">
                                    <label>用户状态:</label>
                                    <div class="form-group">
                                        <select id="sel-status" class="form-control back">
                                            <option value="">全部</option>
                                            <option value="0">未激活</option>
                                            <option value="1">已激活</option>
                                            <option value="2">冻结</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-2 col-sm-3">
                                    <label>来源:</label>
                                    <div class="form-group">
                                        <select id="source_status" class="form-control back">
                                            <option value="">全部</option>
                                            <option value="AVATAR">头像</option>
                                            <option value="PROFILE_IMG">背景</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-4 col-sm-6 col-xs-8">
                                    <label><i class="fa fa-calendar-o">&nbsp;</i>开始时间:</label>
                                    <div class="input-group">
                                        <div class="input-group-addon"><i class="fa fa-calendar"></i></div>
                                        <input class="form-control pull-right" id="txt_date_start" type="text" style="text-align: center">
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-4 col-sm-6 col-xs-8">
                                    <label><i class="fa fa-calendar-o">&nbsp;</i>结束时间:</label>
                                    <div class="input-group">
                                        <div class="input-group-addon"><i class="fa fa-calendar"></i></div>
                                        <input class="form-control pull-right" id="txt_date_end" type="text" style="text-align: center">
                                    </div>
                            </div>
                            </div>
                            <div class="row">
                                <div class="col-md-1">
                                    <label>&nbsp;</label>
                                    <div class="form-group">
                                        <a class="btn btn-primary pull-left" onclick="onSearch()"><i
                                                class="fa fa-fw fa-search"></i>&nbsp;查&nbsp;&nbsp;询</a>
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <label>&nbsp;</label>
                                    <div class="form-group">
                                        <a class="btn btn-primary pull-left" onclick="reset_form()"><i
                                                class="fa fa-fw fa-refresh"></i>&nbsp;重&nbsp;&nbsp;置</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="box box-success">
                        <div id="model_use" class="box-header">
                            <div id="toolbar">
                                <a class="btn btn-success" data-toggle="modal" data-target="#modal_batch_examine"><i class="fa fa-edit"></i>&nbsp;审核</a>
                            </div>
                        </div>
                        <div class="box-body">
                            <table id="dg-user" class="table table-bordered table-hover"
                                   data-url="/user/audit/user/image"
                                   data-toolbar="#toolbar"
                                   data-show-refresh="true"
                                   data-show-toggle="true"
                                   data-show-columns="true"
                                   data-page-list="[10, 25, 50, 100]"
                                   data-single-select="false"
                                   data-click-to-select="true"
                                   data-select-item-name="radioName"
                                   data-checkbox-header="true"
                                   data-maintain-selected="true"
                                   data-query-params="getQueryParams"
                                   data-toggle="table"
                                   data-pagination="true"
                                   data-side-pagination="server"
                                   data-search="false"
                                   data-show-export="true">
                                <thead>
                                <tr>
                                    <th data-checkbox="true" data-click-to-select="true"></th>
                                    <th data-field="mobile"
                                        data-th-align="center"
                                        data-align="center">手机号</th>
                                    <th data-field="user_name"
                                        data-th-align="center"
                                        data-align="center">昵称
                                    </th>
                                    <th data-field="type"
                                        data-formatter="sourceStatus"
                                        data-th-align="center"
                                        data-align="center">来源
                                    </th>
                                    <th data-field="avatar"
                                        data-formatter="YPP.formatter.avatar"
                                        data-th-align="center"
                                        data-align="center">图片</th>
                                    <th data-field="status"
                                        data-formatter="typeState"
                                        data-th-align="center"
                                        data-align="center">用户状态
                                    </th>
                                    <th data-field="imageStatus"
                                        data-formatter="imageStatutes"
                                        data-th-align="center"
                                        data-align="center">处理状态
                                    </th>
                                    <th data-field="vip"
                                        data-formatter="vipStatus"
                                         data-th-align="center"
                                         data-align="center">vip
                                    </th>
                                    <th data-field="change_time"
                                        data-th-align="center"
                                        data-align="center">更换时间</th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- 审核数据 -->
        <div class="modal fade" id="modal_batch_examine" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">批量审核头像/背景</h4>
                    </div>
                    <div class="modal-body ">
                        <div class="form-horizontal">
                            <h4>你确定批量审核这批用户?</h4>
                            <div class="form-group" id="div_for_button">
                                <div class="col-sm-4"></div>
                                <div class="col-sm-2">
                                    <button class="btn btn-block btn-default btn-primary" performance="3">通过</button>
                                </div>
                                <div class="col-sm-2">
                                    <button class="btn btn-block btn-default" performance="1">拒绝</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" data-dismiss="modal" aria-label="Close" class="btn btn-default">取消
                        </button>
                        <button type="button" onclick="batchType()" class="btn btn-success col-lg-pull-6">确定</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- 图像显示 -->
        <div class="modal fade" id="modal_big" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-sm" role="document">
                <div class="modal-content">
                    <div class="modal-body ">
                        <div class="form-horizontal">
                            <div id="apng">
                                <img id="imgApng" border="0" src="/common/lte/img/photo_icon.png" border="2" width=100% height=80%>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script layout:fragment="scripts" th:inline="javascript">
   var sel_choose='用户ID';
   var id='';
   //默认表现形式
   var performance = 3;
   //默认时间
   var now=new Date();
   var defindDate = now.getFullYear()+"-"+((now.getMonth()+1)<10?"0":"")+(now.getMonth()+1)+"-"+(now.getDate()<10?"0":"")+now.getDate()

   var token = $('meta[name="_csrf"]').attr("content");
   var header = $('meta[name="_csrf_hader"]').attr("content");
   $(document).ajaxSend(function (e, xhr, opt) {
       xhr.setRequestHeader(header, token);
   });

   $(function () {
       date();
       $('input[type="checkbox"].flat-red, input[type="radio"].flat-red').iCheck({
           checkboxClass: 'icheckbox_flat-green',
           radioClass: 'iradio_flat-green',
       });

   });

   /**
    * 日期设置
    *
    * */
   function date(){
       $('#txt_date_start').datepicker({minViewMode: 0,format: 'yyyy-mm-dd', language: 'zh-CN', autoclose: true, endDate: defindDate});
       $('#txt_date_end').datepicker({minViewMode: 0,format: 'yyyy-mm-dd', language: 'zh-CN', autoclose: true, endDate: defindDate});
       $('#txt_date_start').val('2017-01-01');
       $('#txt_date_end').val(defindDate);
   }

   /**
    * 查询
    * @param obj
    * @returns {boolean}
    */
   function onSearch() {
        var pageSize = $('#dg-user').bootstrapTable('getOptions')['pageSize'];
        var queryParam = getQueryParams({'offset': 0, 'limit': pageSize});
        $('#dg-user').bootstrapTable('refresh', {
            'url': '/user/audit/user/image',
            'query': queryParam
        });
    }

   /**
    * 搜索
    * @param obj
    * @returns {boolean}
    */
   function onOperation() {
       var pageSize = $('#dg-user').bootstrapTable('getOptions')['pageSize'];
       if(sel_choose !=null){
           switch(sel_choose){
               case '用户ID':
                   queryType='erNo'
                   break;
               case '昵称':
                   queryType='nickname'
                   break;
               case '手机号':
                   queryType='mobile'
                   break;
           }
       }
       return queryType;
   }
   /**
    * 重置所有属性
    * @param obj
    * @returns {boolean}
    */
   function reset_form(){
       $('#txt_query').val("");
       $('#sel-status').val("");
       $('#source_status').val("");
       $('#txt_date_start').val('2017-01-01');
       $('#txt_date_end').val(defindDate);
       $('input[name="vip"]:checked').each(function(){
           $(this).iCheck('uncheck');
       })
   }
   /**
    * 查询参数
    * @param obj
    * @returns {boolean}
    */
    function getQueryParams(params) {

           var dateStart = $('#txt_date_start').val();
           var dateEnd = $('#txt_date_end').val();
           var status = $('#sel-status').val();
           var sourceStatus = $('#source_status').val();
           var input_name = $('#txt_query').val();
           if(dateStart!=null&& dateStart !="" ) {
               params['dateStart'] = dateStart;
               params['dateEnd'] = dateEnd;
           }
           if(status!=null&& status !="" ) {
               params['status'] = status;
           }
           if(sourceStatus!=null&& sourceStatus !="" ){
               params['sourceStatus'] =sourceStatus;
           }
           if(input_name!=null &&input_name!=''){
               params[onOperation()] = input_name;
           }
            var vip_value =[];
            //jquery获取复选框值
            $('input[name="vip"]:checked').each(function(){
                vip_value.push($(this).val());
            })
            params['vip']= vip_value.join(',');
            return params;
        }
   /**
    *
    * 批量审核用户--图像通过或者拒绝
    * @param obj
    * @returns {boolean}
    * */
   function batchType() {
       var batchSelect = $('#dg-user').bootstrapTable('getSelections');
       var type = 1;
       switch (performance) {
           case "1":
               type = 2
               break;
           case "3":
               type = 1
               break;
       }
       if (batchSelect.length == 0) {
           toastr.warning('请选择相应审核列表！')
           return;
       }
       //批量审核的提现Id
       var userIds = [];
       var flag =false;
       $.each(batchSelect, function (n, value) {
           if(value.imageStatus!=0){
               flag =true;
           }
           var keys = value.id;
           var type = value.type;
           userIds.push({'type':type,'id':keys});
       });
       if(flag){
           return toastr.warning('请选择相应待审核列表！')
       }
       var param = {'userId':JSON.stringify(userIds),'auditType':type};
//       param.add(userIds);
//       param['auditType'] = type;
       //开始提交
       $.post('/user/batch/audit/image', param, function (response) {
           if (response.success) {
               $('#dg-user').bootstrapTable('refresh');
               $('#modal_batch_examine').modal('hide');
               toastr.success('审核成功！', 'success', 1500, 'topRight');
           } else {
               toastr.success('审核失败:' + response.message, 'error', 5000, 'topRight');
           }
       })
   }

   $(function () {
       $('.dropdown-menu li').on('click', function () {
           $('#sel_name').text($(this).text()).append('<span class="fa fa-caret-down"></span>');
           sel_choose = $(this).text();
       });
       //表现形式按钮点击
       $('#div_for_button button').click(function () {
           if (performance == $(this).attr("performance"))
               return;
           performance = $(this).attr("performance");
           $('#div_for_button button').removeClass("btn-primary");
           $('#div_for_button button').addClass("btn-default");
           $(this).addClass("btn-primary");
       });

   });
   /**
    * 双击显示大图
    */
   $(function () {
       $('#dg-user').on('dbl-click-row.bs.table', function (e, row, $element) {
           $('#modal_big').modal('show');
           var value = row.avatar;
           //看是否包含http
           if (value.indexOf("http") != 0) {
               value = 'http://photo.eryufm.cn/'+value;
           }
           document.getElementById('imgApng').setAttribute('src',value);
       });
   });
    /**
     *
     * 图片样式转换
     *
     * */
    function returnPicture(value){
        if (value.indexOf("http") == 0) {
            return  value;
        }else{
            return "http://photo.eryufm.cn/"+value;
        }


    }

   /**
    *
    * 状态格式转换
    * */
   function typeState(value) {
       return value == 1 ? "<span style='color: green'>已激活</span>"  : (value == 0 ? "<span style='color: #00a1cb'>未激活</span>" : "<span style='color: red'>冻结</span>");
   }

   /**
    * vip的状态转换
    * @param value
    * @returns {string}
    */
   function vipStatus(value) {
       if(value == null || value ==''){
           return '-'
       }
       return value;
   }

   /**
    * 来源状态切换的状态转换
    * @param value
    * @returns {string}
    */
   function sourceStatus(value) {
       if(value == null || value ==''){
           return '-'
       }
       if(value =='AVATAR')
           return "<span style='color: green'>头像</span>";
       if(value =='PROFILE_IMG')
           return "<span style='color: blue'>背景</span>";
   }

   /**
    * 处理状态切换的状态转换
    * @param value
    * @returns {string}
    */
   function imageStatutes(value) {
       if(value == '0')
           return "<span style='color: darkorange'>待审核</span>";
       if(value == '1')
           return "<span style='color: green'>通过</span>";
       if(value =='2')
           return "<span style='color: red'>拒绝</span>";
   }

</script>
</body>
</html>